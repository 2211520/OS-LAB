# 操作系统实验二：物理内存管理与页表映射简化报告
## 一、基本练习报告内容
### 1.1 物理内存探测与初始化
- **探测方式**：通过OpenSBI的DTB（Device Tree Blob）获取物理内存信息，DTB地址由`a1`寄存器传入，解析得到基地址（默认`0x80000000`）、大小（默认128MiB），可用范围为`[KernelEnd, 0x88000000)`（排除内核与OpenSBI占用区）。
- **初始化流程**：
  1. `page_init()`：初始化`Page`数组，标记内核占用页为`PG_reserved`（不可分配）。
  2. `init_memmap()`：将可用内存初始化为空闲块，设置页帧状态并加入空闲链表。
  3. `pmm_init()`：初始化内存管理器，调用探测与初始化函数，执行分配测试。

### 1.2 核心数据结构
- **Page结构体**：描述单个页帧，含引用计数（`ref`）、状态标志（`flags`，如`PG_reserved`/`PG_property`）、空闲块大小（`property`，仅首页有效）、空闲链表节点（`page_link`）。
- **free_area_t结构体**：管理空闲块，含空闲链表头（`free_list`）、空闲页总数（`nr_free`）。

### 1.3 练习1：First-Fit连续内存分配算法
- **算法原理**：从空闲链表头部遍历，找到第一个满足需求的空闲块分配，优先用低地址内存。
- **核心函数**：
  1. `default_init()`：初始化空闲链表（`free_list`）与空闲页计数（`nr_free=0`）。
  2. `default_init_memmap(base, n)`：初始化`base`开始的`n`个页帧，标记首页`PG_property`，按地址升序加入空闲链表，更新`nr_free`。
  3. `default_alloc_pages(n)`：遍历空闲链表找首个满足大小的块，拆分剩余部分回链表，更新`nr_free`与页帧状态。
  4. `default_free_pages(base, n)`：重置释放页帧状态，按地址插入空闲链表，合并前后相邻空闲块，更新`nr_free`。
- **改进空间**：
  - 优化查找：按块大小分段维护链表，或用平衡树/哈希表降时间复杂度。
  - 减少碎片：引入延迟合并（碎片超阈值整理）或结合伙伴系统。
  - 并发适配：加自旋锁（如`spinlock_t`）确保链表操作原子性。

### 1.4 练习2：Best-Fit连续内存分配算法
- **算法原理**：遍历所有空闲块，选择最小且满足需求的块分配，减少大块拆分，降低碎片但分配速度较慢。
- **核心差异**：仅`best_fit_alloc_pages(n)`与First-Fit不同，初始化`min_size=nr_free+1`，遍历所有块找“最小满足需求”的块，后续拆分、链表更新逻辑与First-Fit一致。
- **实验验证**：执行`make qemu`，输出“`memory management: best_fit_pmm_manager`”“`check_alloc_page() succeeded!`”等信息，表明算法生效。
- **改进空间**：
  - 优化查找：维护按大小升序的链表，或按块大小分组建哈希表。
  - 碎片管理：引入碎片压缩（合并分散小块）或预留应急大空闲块。
  - 预分配缓存：为常见大小块建缓存池，减少链表遍历。

### 1.5 页表与分页机制（RISCV sv39）
- **地址结构**：
  - 虚拟地址（VA）：39位，分27位VPN（虚拟页号）+12位页内偏移。
  - 物理地址（PA）：56位，分44位PPN（物理页号）+12位页内偏移。
  - 页大小：4KB，页内偏移VA与PA一致。
- **三级页表**：将27位VPN拆为3个9位段（VPN[2]/VPN[1]/VPN[0]），一级页表管512个1GiB块、二级管512个2MiB块、三级管512个4KB块，页表项指向下级页表或物理页帧。
- **关键硬件**：
  - TLB（快表）：缓存VPN-PPN映射，减少内存访问。
  - satp寄存器：存页表根节点PPN与模式（sv39为`8<<60`），修改后需`sync.vma`刷新TLB。


## 二、实验重要知识点与OS原理对应关系
| 实验知识点                | OS原理知识点                | 理解（含义、关系、差异）                                                                 |
|---------------------------|-----------------------------|------------------------------------------------------------------------------------------|
| DTB物理内存探测与初始化   | 物理内存探测与管理初始化    | 实验是原理的具体实现：原理指OS启动时需探测硬件内存布局，实验通过解析DTB获取内存参数，流程完全对应，无差异。 |
| Page/free_area_t结构体    | 页帧描述符与空闲块管理      | 原理提出用数据结构描述页帧与空闲块，实验用Page结构体记录页帧状态、free_area_t管理空闲链表，是原理的落地，结构设计与原理一致。 |
| First-Fit/Best-Fit算法    | 连续物理内存分配算法        | 原理定义两种经典算法：First-Fit找首个满足块、Best-Fit找最小满足块；实验实现了这两种算法，逻辑与原理完全匹配，无差异，仅实验需处理具体链表操作。 |
| 三级页表（sv39）          | 多级页表机制                | 原理为解决一级页表内存占用过大，提出拆分页号分级管理；实验的sv39三级页表是原理的实例，27位VPN拆3个9位段，与原理“分级降内存开销”的核心思想一致。 |
| satp寄存器与TLB刷新       | 硬件辅助地址转换            | 原理指出需硬件寄存器存页表根地址、TLB缓存映射；实验中satp存页表根PPN与模式，TLB需`sync.vma`刷新，完全符合原理的硬件支持逻辑。 |


## 三、OS原理重要但实验未覆盖的知识点
1. **页面置换算法**：原理中内存不足时需用LRU、Clock等算法置换页面（虚拟内存“换页”），实验仅实现内存分配，未涉及置换。
2. **内存共享与Copy-on-Write**：原理支持多进程共享物理页帧，并用“写时复制”优化内存使用，实验未涉及进程共享与该优化。
3. **大页（2MiB/1GiB）使用**：原理中用大页减少TLB失效提升效率，实验仅使用4KB普通页，未实现大页功能。
